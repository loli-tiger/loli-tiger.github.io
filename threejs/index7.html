<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js GLB模型加载器 - 支持HDR环境光</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            color: #a0d2eb;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .canvas-section {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            height: 70vh;
        }
        
        #canvas-container {
            width: 100%;
            height: 100%;
        }
        
        .control-section {
            flex: 0 0 350px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ff8a00;
            color: #ff8a00;
        }
        
        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(30, 30, 50, 0.5);
            border-radius: 15px;
            position: relative;
        }
        
        .control-group::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 20px;
            right: 20px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,138,0,0.5), transparent);
        }
        
        .control-group h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #e52e71;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group h3 i {
            font-size: 1.6rem;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #aaa;
        }
        
        input[type="range"] {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: #222;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ff8a00;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 138, 0, 0.7);
            transition: all 0.2s ease;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(255, 138, 0, 0.9);
        }
        
        input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #222;
        }
        
        .value-display {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            color: #ff8a00;
            font-weight: bold;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 12px 0;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .upload-container {
            background: rgba(30, 40, 70, 0.7);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
            border: 2px dashed #4a6fc5;
            position: relative;
            overflow: hidden;
        }
        
        .upload-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(74, 111, 197, 0.2) 0%, transparent 70%);
            opacity: 0.3;
            pointer-events: none;
        }
        
        .upload-container h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #4a9dfc;
        }
        
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #4a6fc5, #4a9dfc);
            color: white;
            padding: 14px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .upload-btn:hover {
            background: linear-gradient(45deg, #4a9dfc, #4a6fc5);
        }
        
        .upload-btn-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .info-panel {
            background: rgba(30, 30, 50, 0.7);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        
        .model-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .model-info p {
            margin: 8px 0;
        }
        
        .model-info strong {
            color: #ff8a00;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #ff8a00;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.5rem;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 70%;
            max-width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .file-name {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #aaa;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            margin-top: 20px;
            font-size: 1rem;
            color: #aaa;
        }
        
        .instructions {
            background: rgba(30, 40, 70, 0.7);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 4px solid #4a9dfc;
        }
        
        .instructions h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #4a9dfc;
        }
        
        .instructions ul {
            padding-left: 25px;
            margin: 15px 0;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .instructions li::before {
            content: "•";
            color: #ff8a00;
            font-size: 1.5rem;
            line-height: 1;
        }
        
        .hdr-preview {
            width: 100%;
            height: 150px;
            background: #111;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
        }
        
        .hdr-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
        }
        
        .hdr-preview::after {
            content: "HDR预览";
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ff8a00;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .hdr-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .hdr-controls .btn {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
        }
        
        .env-intensity {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .env-intensity label {
            margin-bottom: 0;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .canvas-section {
                height: 50vh;
            }
            
            .control-section {
                flex: 0 0 auto;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Three.js GLB模型加载器</h1>
            <p class="subtitle">支持本地GLB文件上传与HDR环境光设置 - 专业级3D模型查看体验</p>
        </header>
        
        <div class="main-content">
            <div class="canvas-section">
                <div id="canvas-container"></div>
                <div class="loading-overlay" id="loading-overlay">
                    <div class="loader"></div>
                    <div class="loading-text">加载模型中...</div>
                    <div class="progress-bar">
                        <div class="progress" id="loading-progress"></div>
                    </div>
                    <div id="file-name" class="file-name"></div>
                </div>
            </div>
            
            <div class="control-section">
                <h2 class="section-title">控制面板</h2>
                
                <div class="control-group">
                    <h3><i>📷</i> 相机控制</h3>
                    <div class="slider-container">
                        <label>X轴旋转: <span class="value-display" id="rotation-x-value">0°</span></label>
                        <input type="range" id="rotation-x" min="-180" max="180" value="0">
                    </div>
                    <div class="slider-container">
                        <label>Y轴旋转: <span class="value-display" id="rotation-y-value">0°</span></label>
                        <input type="range" id="rotation-y" min="-180" max="180" value="0">
                    </div>
                    <div class="slider-container">
                        <label>缩放: <span class="value-display" id="zoom-value">1.0</span></label>
                        <input type="range" id="zoom" min="0.1" max="2" step="0.01" value="1">
                    </div>
                </div>
                
                <div class="control-group">
                    <h3><i>💡</i> 灯光控制</h3>
                    <div class="slider-container">
                        <label>灯光强度: <span class="value-display" id="light-intensity-value">1.0</span></label>
                        <input type="range" id="light-intensity" min="0" max="2" step="0.1" value="1">
                    </div>
                    <div class="slider-container">
                        <label>灯光颜色</label>
                        <input type="color" id="light-color" value="#ffffff">
                    </div>
                    <button class="btn" id="toggle-shadows">切换阴影</button>
                </div>
                
                <div class="control-group">
                    <h3><i>✨</i> HDR环境光</h3>
                    <p>上传HDR文件作为环境光源（不会显示在背景中）</p>
                    
                    <div class="upload-container">
                        <div class="upload-btn-wrapper">
                            <div class="upload-btn">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 15H13V9H16L12 4L8 9H11V15Z" fill="white"/>
                                    <path d="M20 18H4V11H2V18C2 19.103 2.897 20 4 20H20C21.103 20 22 19.103 22 18V11H20V18Z" fill="white"/>
                                </svg>
                                选择HDR文件
                            </div>
                            <input type="file" id="hdr-upload" accept=".hdr">
                        </div>
                        <div id="hdr-file-name" class="file-name"></div>
                        
                        <div class="hdr-preview" id="hdr-preview">
                            <div style="display:flex;height:100%;align-items:center;justify-content:center;color:#666;">
                                上传HDR后将显示预览
                            </div>
                        </div>
                        
                        <div class="env-intensity">
                            <label>环境光强度: <span class="value-display" id="env-intensity-value">1.0</span></label>
                            <input type="range" id="env-intensity" min="0" max="2" step="0.1" value="1">
                        </div>
                        
                        <div class="hdr-controls">
                            <button class="btn" id="apply-hdr">应用HDR</button>
                            <button class="btn" id="remove-hdr">移除HDR</button>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3><i>🔄</i> 模型操作</h3>
                    <button class="btn" id="reset-model">重置模型</button>
                    <button class="btn" id="toggle-animation">切换动画</button>
                    <button class="btn" id="change-model">更换预置模型</button>
                </div>
                
                <div class="upload-container">
                    <h3>上传本地GLB模型</h3>
                    <div class="upload-btn-wrapper">
                        <div class="upload-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11 15H13V9H16L12 4L8 9H11V15Z" fill="white"/>
                                <path d="M20 18H4V11H2V18C2 19.103 2.897 20 4 20H20C21.103 20 22 19.103 22 18V11H20V18Z" fill="white"/>
                            </svg>
                            选择GLB文件
                        </div>
                        <input type="file" id="model-upload" accept=".glb">
                    </div>
                    <div id="upload-file-name" class="file-name"></div>
                </div>
                
                <div class="info-panel">
                    <h3>模型信息</h3>
                    <div class="model-info">
                        <p><strong>当前模型:</strong> <span id="model-name">损坏头盔</span></p>
                        <p><strong>模型类型:</strong> <span id="model-type">预置模型</span></p>
                        <p><strong>文件大小:</strong> <span id="model-size">1.2 MB</span></p>
                        <p><strong>顶点数量:</strong> <span id="vertex-count">加载中...</span></p>
                        <p><strong>环境光:</strong> <span id="env-info">默认环境光</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>使用说明</h3>
            <ul>
                <li>使用右侧控制面板调整模型视角、灯光和环境光效果</li>
                <li>点击"上传本地GLB模型"按钮选择本地的GLB格式3D模型文件</li>
                <li>上传HDR文件作为环境光源，不会显示在背景中</li>
                <li>支持拖动模型进行旋转，滚轮进行缩放</li>
                <li>预置模型包括头盔、机器人等示例模型</li>
                <li>模型加载后，可调整灯光、旋转模型等参数</li>
            </ul>
            <p><strong>注意：</strong>大型模型文件可能需要较长时间加载，请耐心等待</p>
        </div>
        
        <footer>
            Three.js GLB模型加载器 | 支持HDR环境光 | 专业级3D渲染 | 基于WebGL技术
        </footer>
    </div>

    <script>
        // 主要变量
        let scene, camera, renderer, model, mixer, clock, controls;
        let directionalLight, ambientLight, envLight;
        let currentModel = 'DamagedHelmet';
        let currentHDR = null;
        const models = {
            'DamagedHelmet': {
                path: 'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.glb',
                size: '1.2 MB',
                scale: 1.0,
                name: '损坏头盔'
            },
            'FlightHelmet': {
                path: 'https://threejs.org/examples/models/gltf/FlightHelmet/glTF/FlightHelmet.glb',
                size: '5.4 MB',
                scale: 1.5,
                name: '飞行头盔'
            },
            'RobotExpressive': {
                path: 'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
                size: '1.8 MB',
                scale: 0.8,
                name: '表情机器人'
            }
        };

        // 初始化Three.js场景
        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1a);
            scene.fog = new THREE.FogExp2(0x0a0a1a, 0.002);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(
                45, 
                (window.innerWidth - 350) / (window.innerHeight - 150), 
                0.1, 
                1000
            );
            camera.position.set(0, 0.5, 5);
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setSize(document.querySelector('.canvas-section').offsetWidth, 
                            document.querySelector('.canvas-section').offsetHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // 添加轨道控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // 添加灯光
            ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(2, 5, 3);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 添加环境光
            envLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(envLight);
            
            // 添加辅助工具
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            const axesHelper = new THREE.AxesHelper(3);
            scene.add(axesHelper);
            
            // 初始化时钟
            clock = new THREE.Clock();
            
            // 加载初始模型
            loadModel(models[currentModel].path, models[currentModel].name);
            
            // 添加事件监听器
            setupEventListeners();
            
            // 开始动画循环
            animate();
        }
        
        // 加载GLB模型
        function loadModel(url, modelName = "自定义模型", fileSize = "计算中...") {
            // 显示加载界面
            const loadingOverlay = document.getElementById('loading-overlay');
            const progressBar = document.getElementById('loading-progress');
            const fileNameDisplay = document.getElementById('file-name');
            
            loadingOverlay.style.display = 'flex';
            progressBar.style.width = '0%';
            fileNameDisplay.textContent = `正在加载: ${modelName}`;
            fileNameDisplay.style.color = '#4a9dfc';
            
            // 清除现有模型
            if (model) {
                scene.remove(model);
                if (mixer) mixer.stopAllAction();
            }
            
            // 创建加载器
            const loader = new THREE.GLTFLoader();
            
            // 加载模型
            loader.load(
                url,
                function (gltf) {
                    model = gltf.scene;
                    
                    // 更新模型信息
                    document.getElementById('model-name').textContent = modelName;
                    document.getElementById('model-type').textContent = 
                        url.startsWith('blob:') ? '上传模型' : '预置模型';
                    document.getElementById('model-size').textContent = fileSize;
                    
                    // 计算顶点数
                    let vertexCount = 0;
                    let triangleCount = 0;
                    model.traverse(function (child) {
                        if (child.isMesh) {
                            vertexCount += child.geometry.attributes.position.count;
                            if (child.geometry.index) {
                                triangleCount += child.geometry.index.count / 3;
                            } else {
                                triangleCount += child.geometry.attributes.position.count / 3;
                            }
                        }
                    });
                    document.getElementById('vertex-count').textContent = 
                        `${vertexCount.toLocaleString()} (${triangleCount.toLocaleString()} 个三角面)`;
                    
                    // 设置模型位置和缩放
                    model.position.set(0, -0.5, 0);
                    
                    // 根据模型类型设置缩放
                    let modelScale = 1.0;
                    if (models[currentModel]) {
                        modelScale = models[currentModel].scale;
                    } else {
                        // 对于上传的模型，自动调整缩放
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3()).length();
                        modelScale = 2.5 / size;
                    }
                    model.scale.set(modelScale, modelScale, modelScale);
                    
                    // 设置模型可投射和接收阴影
                    model.traverse(function (child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            
                            // 应用环境贴图
                            if (currentHDR) {
                                child.material.envMap = currentHDR;
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    scene.add(model);
                    
                    // 处理动画
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(model);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                        document.getElementById('toggle-animation').style.display = 'block';
                    } else {
                        document.getElementById('toggle-animation').style.display = 'none';
                    }
                    
                    // 隐藏加载界面
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                },
                function (xhr) {
                    // 加载进度更新
                    const percent = (xhr.loaded / xhr.total * 100);
                    progressBar.style.width = `${percent}%`;
                },
                function (error) {
                    console.error('模型加载出错:', error);
                    loadingOverlay.style.display = 'none';
                    
                    // 显示错误信息
                    fileNameDisplay.textContent = `加载失败: ${error.message}`;
                    fileNameDisplay.style.color = '#ff6b6b';
                    
                    setTimeout(() => {
                        fileNameDisplay.textContent = '';
                        fileNameDisplay.style.color = '';
                    }, 3000);
                }
            );
        }
        
        // 加载HDR环境贴图
        function loadHDREnvironment(file) {
            const reader = new FileReader();
            const fileNameDisplay = document.getElementById('hdr-file-name');
            const hdrPreview = document.getElementById('hdr-preview');
            
            fileNameDisplay.textContent = `已选择: ${file.name}`;
            fileNameDisplay.style.color = '#4a9dfc';
            
            // 显示临时预览
            hdrPreview.innerHTML = `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#666;">
                HDR文件加载中...
            </div>`;
            
            reader.onload = function(event) {
                const hdrData = event.target.result;
                
                // 使用RGBELoader解析HDR
                const loader = new THREE.RGBELoader();
                loader.load(hdrData, function(texture) {
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    
                    // 更新环境贴图
                    if (currentHDR) {
                        scene.environment.dispose();
                    }
                    
                    scene.environment = texture;
                    currentHDR = texture;
                    
                    // 更新模型材质的环境贴图
                    if (model) {
                        model.traverse(function(child) {
                            if (child.isMesh && child.material) {
                                child.material.envMap = texture;
                                child.material.needsUpdate = true;
                            }
                        });
                    }
                    
                    // 创建预览图像
                    createHDRPreview(texture, hdrPreview);
                    
                    // 更新环境信息
                    document.getElementById('env-info').textContent = file.name;
                    document.getElementById('env-info').style.color = '#4a9dfc';
                    
                    // 应用当前环境光强度
                    updateEnvIntensity();
                }, undefined, function(error) {
                    console.error('HDR加载错误:', error);
                    fileNameDisplay.textContent = `HDR加载失败: ${error.message}`;
                    fileNameDisplay.style.color = '#ff6b6b';
                    
                    hdrPreview.innerHTML = `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#ff6b6b;">
                        HDR加载失败
                    </div>`;
                });
            };
            
            reader.readAsDataURL(file);
        }
        
        // 创建HDR预览
        function createHDRPreview(texture, container) {
            // 创建临时canvas渲染预览
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 200;
            
            // 创建临时场景渲染HDR
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
            camera.position.z = 1.5;
            
            const geometry = new THREE.SphereGeometry(1, 64, 32);
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.BackSide
            });
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            
            const renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                alpha: true,
                preserveDrawingBuffer: true
            });
            renderer.setSize(canvas.width, canvas.height);
            renderer.render(scene, camera);
            
            // 创建预览图像
            const img = new Image();
            img.src = canvas.toDataURL();
            img.onload = function() {
                container.innerHTML = '';
                container.appendChild(img);
            };
        }
        
        // 更新环境光强度
        function updateEnvIntensity() {
            const intensity = parseFloat(document.getElementById('env-intensity').value);
            document.getElementById('env-intensity-value').textContent = intensity.toFixed(1);
            
            if (scene.environment) {
                // 调整环境贴图强度
                renderer.toneMappingExposure = intensity;
            }
            
            // 调整环境光强度
            envLight.intensity = intensity * 0.5;
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 旋转控制
            document.getElementById('rotation-x').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('rotation-x-value').textContent = `${value}°`;
                if (model) model.rotation.x = THREE.MathUtils.degToRad(value);
            });
            
            document.getElementById('rotation-y').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('rotation-y-value').textContent = `${value}°`;
                if (model) model.rotation.y = THREE.MathUtils.degToRad(value);
            });
            
            // 缩放控制
            document.getElementById('zoom').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('zoom-value').textContent = value;
                camera.position.z = 5 / value;
            });
            
            // 灯光控制
            document.getElementById('light-intensity').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('light-intensity-value').textContent = value;
                directionalLight.intensity = value;
            });
            
            document.getElementById('light-color').addEventListener('input', function(e) {
                directionalLight.color = new THREE.Color(e.target.value);
            });
            
            // 环境光强度控制
            document.getElementById('env-intensity').addEventListener('input', updateEnvIntensity);
            
            // 阴影切换
            document.getElementById('toggle-shadows').addEventListener('click', function() {
                renderer.shadowMap.enabled = !renderer.shadowMap.enabled;
                this.textContent = renderer.shadowMap.enabled ? 
                    '关闭阴影' : '开启阴影';
            });
            
            // 重置模型
            document.getElementById('reset-model').addEventListener('click', function() {
                if (model) {
                    model.rotation.set(0, 0, 0);
                    document.getElementById('rotation-x').value = 0;
                    document.getElementById('rotation-y').value = 0;
                    document.getElementById('rotation-x-value').textContent = '0°';
                    document.getElementById('rotation-y-value').textContent = '0°';
                    
                    document.getElementById('zoom').value = 1;
                    document.getElementById('zoom-value').textContent = '1';
                    camera.position.z = 5;
                }
            });
            
            // 切换动画
            document.getElementById('toggle-animation').addEventListener('click', function() {
                if (mixer) {
                    if (mixer.timeScale === 0) {
                        mixer.timeScale = 1;
                        this.textContent = '停止动画';
                    } else {
                        mixer.timeScale = 0;
                        this.textContent = '播放动画';
                    }
                }
            });
            
            // 更换预置模型
            document.getElementById('change-model').addEventListener('click', function() {
                const modelKeys = Object.keys(models);
                const currentIndex = modelKeys.indexOf(currentModel);
                const nextIndex = (currentIndex + 1) % modelKeys.length;
                currentModel = modelKeys[nextIndex];
                loadModel(models[currentModel].path, models[currentModel].name, models[currentModel].size);
            });
            
            // 窗口大小调整
            window.addEventListener('resize', function() {
                const canvasSection = document.querySelector('.canvas-section');
                const width = canvasSection.offsetWidth;
                const height = canvasSection.offsetHeight;
                
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });
            
            // 模型文件上传处理
            document.getElementById('model-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // 检查文件扩展名
                if (!file.name.toLowerCase().endsWith('.glb')) {
                    alert('请选择GLB格式的文件！');
                    return;
                }
                
                // 显示文件名
                const fileNameDisplay = document.getElementById('upload-file-name');
                fileNameDisplay.textContent = `已选择: ${file.name}`;
                fileNameDisplay.style.color = '#4a9dfc';
                
                // 显示文件大小
                const fileSize = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                
                // 创建文件URL
                const url = URL.createObjectURL(file);
                
                // 更新当前模型名称
                currentModel = 'custom';
                
                // 加载模型
                loadModel(url, file.name, fileSize);
                
                // 清理URL对象
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
            });
            
            // HDR文件上传处理
            document.getElementById('hdr-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // 检查文件扩展名
                if (!file.name.toLowerCase().endsWith('.hdr')) {
                    alert('请选择HDR格式的文件！');
                    return;
                }
                
                // 加载HDR环境贴图
                loadHDREnvironment(file);
            });
            
            // 应用HDR按钮
            document.getElementById('apply-hdr').addEventListener('click', function() {
                if (!currentHDR) {
                    alert('请先上传HDR文件！');
                    return;
                }
                
                // 确保环境贴图已应用
                scene.environment = currentHDR;
                
                // 更新模型材质的环境贴图
                if (model) {
                    model.traverse(function(child) {
                        if (child.isMesh && child.material) {
                            child.material.envMap = currentHDR;
                            child.material.needsUpdate = true;
                        }
                    });
                }
                
                updateEnvIntensity();
                alert('HDR环境光已应用！');
            });
            
            // 移除HDR按钮
            document.getElementById('remove-hdr').addEventListener('click', function() {
                if (scene.environment) {
                    scene.environment.dispose();
                    scene.environment = null;
                    currentHDR = null;
                    
                    // 更新模型材质的环境贴图
                    if (model) {
                        model.traverse(function(child) {
                            if (child.isMesh && child.material) {
                                child.material.envMap = null;
                                child.material.needsUpdate = true;
                            }
                        });
                    }
                    
                    // 重置预览
                    document.getElementById('hdr-preview').innerHTML = 
                        `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#666;">
                            上传HDR后将显示预览
                        </div>`;
                    
                    document.getElementById('hdr-file-name').textContent = '';
                    document.getElementById('env-info').textContent = '默认环境光';
                    document.getElementById('env-info').style.color = '';
                    
                    alert('HDR环境光已移除！');
                } else {
                    alert('当前没有应用HDR环境光！');
                }
            });
            
            // 添加鼠标控制
            let isDragging = false;
            let previousMousePosition = {
                x: 0,
                y: 0
            };
            
            // 鼠标按下事件
            renderer.domElement.addEventListener('mousedown', function(e) {
                isDragging = true;
                previousMousePosition = {
                    x: e.clientX,
                    y: e.clientY
                };
            });
            
            // 鼠标移动事件
            renderer.domElement.addEventListener('mousemove', function(e) {
                if (!isDragging || !model) return;
                
                const deltaMove = {
                    x: e.clientX - previousMousePosition.x,
                    y: e.clientY - previousMousePosition.y
                };
                
                model.rotation.y += deltaMove.x * 0.01;
                model.rotation.x += deltaMove.y * 0.01;
                
                // 更新滑块值
                document.getElementById('rotation-x').value = THREE.MathUtils.radToDeg(model.rotation.x);
                document.getElementById('rotation-y').value = THREE.MathUtils.radToDeg(model.rotation.y);
                document.getElementById('rotation-x-value').textContent = 
                    `${Math.round(THREE.MathUtils.radToDeg(model.rotation.x))}°`;
                document.getElementById('rotation-y-value').textContent = 
                    `${Math.round(THREE.MathUtils.radToDeg(model.rotation.y))}°`;
                
                previousMousePosition = {
                    x: e.clientX,
                    y: e.clientY
                };
            });
            
            // 鼠标释放事件
            renderer.domElement.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            renderer.domElement.addEventListener('mouseleave', function() {
                isDragging = false;
            });
            
            // 鼠标滚轮缩放
            renderer.domElement.addEventListener('wheel', function(e) {
                if (!model) return;
                
                e.preventDefault();
                
                // 计算新的缩放值
                let zoomValue = parseFloat(document.getElementById('zoom').value);
                zoomValue += e.deltaY * -0.001;
                
                // 限制缩放范围
                zoomValue = Math.min(Math.max(zoomValue, 0.1), 2);
                
                // 更新缩放值
                document.getElementById('zoom').value = zoomValue;
                document.getElementById('zoom-value').textContent = zoomValue.toFixed(2);
                camera.position.z = 5 / zoomValue;
            });
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 更新控制器
            if (controls) controls.update();
            
            // 更新动画混合器
            if (mixer) {
                mixer.update(clock.getDelta());
            }
            
            // 渲染场景
            renderer.render(scene, camera);
        }
        
        // 启动应用
        window.onload = init;
    </script>
</body>
</html>
