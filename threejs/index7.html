<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js GLBæ¨¡å‹åŠ è½½å™¨ - æ”¯æŒHDRç¯å¢ƒå…‰</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            color: #a0d2eb;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .canvas-section {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            height: 70vh;
        }
        
        #canvas-container {
            width: 100%;
            height: 100%;
        }
        
        .control-section {
            flex: 0 0 350px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ff8a00;
            color: #ff8a00;
        }
        
        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(30, 30, 50, 0.5);
            border-radius: 15px;
            position: relative;
        }
        
        .control-group::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 20px;
            right: 20px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,138,0,0.5), transparent);
        }
        
        .control-group h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #e52e71;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group h3 i {
            font-size: 1.6rem;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #aaa;
        }
        
        input[type="range"] {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: #222;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ff8a00;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 138, 0, 0.7);
            transition: all 0.2s ease;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(255, 138, 0, 0.9);
        }
        
        input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #222;
        }
        
        .value-display {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            color: #ff8a00;
            font-weight: bold;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 12px 0;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .upload-container {
            background: rgba(30, 40, 70, 0.7);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
            border: 2px dashed #4a6fc5;
            position: relative;
            overflow: hidden;
        }
        
        .upload-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(74, 111, 197, 0.2) 0%, transparent 70%);
            opacity: 0.3;
            pointer-events: none;
        }
        
        .upload-container h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #4a9dfc;
        }
        
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #4a6fc5, #4a9dfc);
            color: white;
            padding: 14px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .upload-btn:hover {
            background: linear-gradient(45deg, #4a9dfc, #4a6fc5);
        }
        
        .upload-btn-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .info-panel {
            background: rgba(30, 30, 50, 0.7);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        
        .model-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .model-info p {
            margin: 8px 0;
        }
        
        .model-info strong {
            color: #ff8a00;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #ff8a00;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.5rem;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 70%;
            max-width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .file-name {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #aaa;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            margin-top: 20px;
            font-size: 1rem;
            color: #aaa;
        }
        
        .instructions {
            background: rgba(30, 40, 70, 0.7);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 4px solid #4a9dfc;
        }
        
        .instructions h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #4a9dfc;
        }
        
        .instructions ul {
            padding-left: 25px;
            margin: 15px 0;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .instructions li::before {
            content: "â€¢";
            color: #ff8a00;
            font-size: 1.5rem;
            line-height: 1;
        }
        
        .hdr-preview {
            width: 100%;
            height: 150px;
            background: #111;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
        }
        
        .hdr-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
        }
        
        .hdr-preview::after {
            content: "HDRé¢„è§ˆ";
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ff8a00;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .hdr-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .hdr-controls .btn {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
        }
        
        .env-intensity {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .env-intensity label {
            margin-bottom: 0;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .canvas-section {
                height: 50vh;
            }
            
            .control-section {
                flex: 0 0 auto;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Three.js GLBæ¨¡å‹åŠ è½½å™¨</h1>
            <p class="subtitle">æ”¯æŒæœ¬åœ°GLBæ–‡ä»¶ä¸Šä¼ ä¸HDRç¯å¢ƒå…‰è®¾ç½® - ä¸“ä¸šçº§3Dæ¨¡å‹æŸ¥çœ‹ä½“éªŒ</p>
        </header>
        
        <div class="main-content">
            <div class="canvas-section">
                <div id="canvas-container"></div>
                <div class="loading-overlay" id="loading-overlay">
                    <div class="loader"></div>
                    <div class="loading-text">åŠ è½½æ¨¡å‹ä¸­...</div>
                    <div class="progress-bar">
                        <div class="progress" id="loading-progress"></div>
                    </div>
                    <div id="file-name" class="file-name"></div>
                </div>
            </div>
            
            <div class="control-section">
                <h2 class="section-title">æ§åˆ¶é¢æ¿</h2>
                
                <div class="control-group">
                    <h3><i>ğŸ“·</i> ç›¸æœºæ§åˆ¶</h3>
                    <div class="slider-container">
                        <label>Xè½´æ—‹è½¬: <span class="value-display" id="rotation-x-value">0Â°</span></label>
                        <input type="range" id="rotation-x" min="-180" max="180" value="0">
                    </div>
                    <div class="slider-container">
                        <label>Yè½´æ—‹è½¬: <span class="value-display" id="rotation-y-value">0Â°</span></label>
                        <input type="range" id="rotation-y" min="-180" max="180" value="0">
                    </div>
                    <div class="slider-container">
                        <label>ç¼©æ”¾: <span class="value-display" id="zoom-value">1.0</span></label>
                        <input type="range" id="zoom" min="0.1" max="2" step="0.01" value="1">
                    </div>
                </div>
                
                <div class="control-group">
                    <h3><i>ğŸ’¡</i> ç¯å…‰æ§åˆ¶</h3>
                    <div class="slider-container">
                        <label>ç¯å…‰å¼ºåº¦: <span class="value-display" id="light-intensity-value">1.0</span></label>
                        <input type="range" id="light-intensity" min="0" max="2" step="0.1" value="1">
                    </div>
                    <div class="slider-container">
                        <label>ç¯å…‰é¢œè‰²</label>
                        <input type="color" id="light-color" value="#ffffff">
                    </div>
                    <button class="btn" id="toggle-shadows">åˆ‡æ¢é˜´å½±</button>
                </div>
                
                <div class="control-group">
                    <h3><i>âœ¨</i> HDRç¯å¢ƒå…‰</h3>
                    <p>ä¸Šä¼ HDRæ–‡ä»¶ä½œä¸ºç¯å¢ƒå…‰æºï¼ˆä¸ä¼šæ˜¾ç¤ºåœ¨èƒŒæ™¯ä¸­ï¼‰</p>
                    
                    <div class="upload-container">
                        <div class="upload-btn-wrapper">
                            <div class="upload-btn">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 15H13V9H16L12 4L8 9H11V15Z" fill="white"/>
                                    <path d="M20 18H4V11H2V18C2 19.103 2.897 20 4 20H20C21.103 20 22 19.103 22 18V11H20V18Z" fill="white"/>
                                </svg>
                                é€‰æ‹©HDRæ–‡ä»¶
                            </div>
                            <input type="file" id="hdr-upload" accept=".hdr">
                        </div>
                        <div id="hdr-file-name" class="file-name"></div>
                        
                        <div class="hdr-preview" id="hdr-preview">
                            <div style="display:flex;height:100%;align-items:center;justify-content:center;color:#666;">
                                ä¸Šä¼ HDRåå°†æ˜¾ç¤ºé¢„è§ˆ
                            </div>
                        </div>
                        
                        <div class="env-intensity">
                            <label>ç¯å¢ƒå…‰å¼ºåº¦: <span class="value-display" id="env-intensity-value">1.0</span></label>
                            <input type="range" id="env-intensity" min="0" max="2" step="0.1" value="1">
                        </div>
                        
                        <div class="hdr-controls">
                            <button class="btn" id="apply-hdr">åº”ç”¨HDR</button>
                            <button class="btn" id="remove-hdr">ç§»é™¤HDR</button>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3><i>ğŸ”„</i> æ¨¡å‹æ“ä½œ</h3>
                    <button class="btn" id="reset-model">é‡ç½®æ¨¡å‹</button>
                    <button class="btn" id="toggle-animation">åˆ‡æ¢åŠ¨ç”»</button>
                    <button class="btn" id="change-model">æ›´æ¢é¢„ç½®æ¨¡å‹</button>
                </div>
                
                <div class="upload-container">
                    <h3>ä¸Šä¼ æœ¬åœ°GLBæ¨¡å‹</h3>
                    <div class="upload-btn-wrapper">
                        <div class="upload-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11 15H13V9H16L12 4L8 9H11V15Z" fill="white"/>
                                <path d="M20 18H4V11H2V18C2 19.103 2.897 20 4 20H20C21.103 20 22 19.103 22 18V11H20V18Z" fill="white"/>
                            </svg>
                            é€‰æ‹©GLBæ–‡ä»¶
                        </div>
                        <input type="file" id="model-upload" accept=".glb">
                    </div>
                    <div id="upload-file-name" class="file-name"></div>
                </div>
                
                <div class="info-panel">
                    <h3>æ¨¡å‹ä¿¡æ¯</h3>
                    <div class="model-info">
                        <p><strong>å½“å‰æ¨¡å‹:</strong> <span id="model-name">æŸåå¤´ç›”</span></p>
                        <p><strong>æ¨¡å‹ç±»å‹:</strong> <span id="model-type">é¢„ç½®æ¨¡å‹</span></p>
                        <p><strong>æ–‡ä»¶å¤§å°:</strong> <span id="model-size">1.2 MB</span></p>
                        <p><strong>é¡¶ç‚¹æ•°é‡:</strong> <span id="vertex-count">åŠ è½½ä¸­...</span></p>
                        <p><strong>ç¯å¢ƒå…‰:</strong> <span id="env-info">é»˜è®¤ç¯å¢ƒå…‰</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>ä½¿ç”¨å³ä¾§æ§åˆ¶é¢æ¿è°ƒæ•´æ¨¡å‹è§†è§’ã€ç¯å…‰å’Œç¯å¢ƒå…‰æ•ˆæœ</li>
                <li>ç‚¹å‡»"ä¸Šä¼ æœ¬åœ°GLBæ¨¡å‹"æŒ‰é’®é€‰æ‹©æœ¬åœ°çš„GLBæ ¼å¼3Dæ¨¡å‹æ–‡ä»¶</li>
                <li>ä¸Šä¼ HDRæ–‡ä»¶ä½œä¸ºç¯å¢ƒå…‰æºï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨èƒŒæ™¯ä¸­</li>
                <li>æ”¯æŒæ‹–åŠ¨æ¨¡å‹è¿›è¡Œæ—‹è½¬ï¼Œæ»šè½®è¿›è¡Œç¼©æ”¾</li>
                <li>é¢„ç½®æ¨¡å‹åŒ…æ‹¬å¤´ç›”ã€æœºå™¨äººç­‰ç¤ºä¾‹æ¨¡å‹</li>
                <li>æ¨¡å‹åŠ è½½åï¼Œå¯è°ƒæ•´ç¯å…‰ã€æ—‹è½¬æ¨¡å‹ç­‰å‚æ•°</li>
            </ul>
            <p><strong>æ³¨æ„ï¼š</strong>å¤§å‹æ¨¡å‹æ–‡ä»¶å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´åŠ è½½ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        </div>
        
        <footer>
            Three.js GLBæ¨¡å‹åŠ è½½å™¨ | æ”¯æŒHDRç¯å¢ƒå…‰ | ä¸“ä¸šçº§3Dæ¸²æŸ“ | åŸºäºWebGLæŠ€æœ¯
        </footer>
    </div>

    <script>
        // ä¸»è¦å˜é‡
        let scene, camera, renderer, model, mixer, clock, controls;
        let directionalLight, ambientLight, envLight;
        let currentModel = 'DamagedHelmet';
        let currentHDR = null;
        const models = {
            'DamagedHelmet': {
                path: 'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.glb',
                size: '1.2 MB',
                scale: 1.0,
                name: 'æŸåå¤´ç›”'
            },
            'FlightHelmet': {
                path: 'https://threejs.org/examples/models/gltf/FlightHelmet/glTF/FlightHelmet.glb',
                size: '5.4 MB',
                scale: 1.5,
                name: 'é£è¡Œå¤´ç›”'
            },
            'RobotExpressive': {
                path: 'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
                size: '1.8 MB',
                scale: 0.8,
                name: 'è¡¨æƒ…æœºå™¨äºº'
            }
        };

        // åˆå§‹åŒ–Three.jsåœºæ™¯
        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1a);
            scene.fog = new THREE.FogExp2(0x0a0a1a, 0.002);
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(
                45, 
                (window.innerWidth - 350) / (window.innerHeight - 150), 
                0.1, 
                1000
            );
            camera.position.set(0, 0.5, 5);
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setSize(document.querySelector('.canvas-section').offsetWidth, 
                            document.querySelector('.canvas-section').offsetHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // æ·»åŠ è½¨é“æ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // æ·»åŠ ç¯å…‰
            ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(2, 5, 3);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // æ·»åŠ ç¯å¢ƒå…‰
            envLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(envLight);
            
            // æ·»åŠ è¾…åŠ©å·¥å…·
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            const axesHelper = new THREE.AxesHelper(3);
            scene.add(axesHelper);
            
            // åˆå§‹åŒ–æ—¶é’Ÿ
            clock = new THREE.Clock();
            
            // åŠ è½½åˆå§‹æ¨¡å‹
            loadModel(models[currentModel].path, models[currentModel].name);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
        }
        
        // åŠ è½½GLBæ¨¡å‹
        function loadModel(url, modelName = "è‡ªå®šä¹‰æ¨¡å‹", fileSize = "è®¡ç®—ä¸­...") {
            // æ˜¾ç¤ºåŠ è½½ç•Œé¢
            const loadingOverlay = document.getElementById('loading-overlay');
            const progressBar = document.getElementById('loading-progress');
            const fileNameDisplay = document.getElementById('file-name');
            
            loadingOverlay.style.display = 'flex';
            progressBar.style.width = '0%';
            fileNameDisplay.textContent = `æ­£åœ¨åŠ è½½: ${modelName}`;
            fileNameDisplay.style.color = '#4a9dfc';
            
            // æ¸…é™¤ç°æœ‰æ¨¡å‹
            if (model) {
                scene.remove(model);
                if (mixer) mixer.stopAllAction();
            }
            
            // åˆ›å»ºåŠ è½½å™¨
            const loader = new THREE.GLTFLoader();
            
            // åŠ è½½æ¨¡å‹
            loader.load(
                url,
                function (gltf) {
                    model = gltf.scene;
                    
                    // æ›´æ–°æ¨¡å‹ä¿¡æ¯
                    document.getElementById('model-name').textContent = modelName;
                    document.getElementById('model-type').textContent = 
                        url.startsWith('blob:') ? 'ä¸Šä¼ æ¨¡å‹' : 'é¢„ç½®æ¨¡å‹';
                    document.getElementById('model-size').textContent = fileSize;
                    
                    // è®¡ç®—é¡¶ç‚¹æ•°
                    let vertexCount = 0;
                    let triangleCount = 0;
                    model.traverse(function (child) {
                        if (child.isMesh) {
                            vertexCount += child.geometry.attributes.position.count;
                            if (child.geometry.index) {
                                triangleCount += child.geometry.index.count / 3;
                            } else {
                                triangleCount += child.geometry.attributes.position.count / 3;
                            }
                        }
                    });
                    document.getElementById('vertex-count').textContent = 
                        `${vertexCount.toLocaleString()} (${triangleCount.toLocaleString()} ä¸ªä¸‰è§’é¢)`;
                    
                    // è®¾ç½®æ¨¡å‹ä½ç½®å’Œç¼©æ”¾
                    model.position.set(0, -0.5, 0);
                    
                    // æ ¹æ®æ¨¡å‹ç±»å‹è®¾ç½®ç¼©æ”¾
                    let modelScale = 1.0;
                    if (models[currentModel]) {
                        modelScale = models[currentModel].scale;
                    } else {
                        // å¯¹äºä¸Šä¼ çš„æ¨¡å‹ï¼Œè‡ªåŠ¨è°ƒæ•´ç¼©æ”¾
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3()).length();
                        modelScale = 2.5 / size;
                    }
                    model.scale.set(modelScale, modelScale, modelScale);
                    
                    // è®¾ç½®æ¨¡å‹å¯æŠ•å°„å’Œæ¥æ”¶é˜´å½±
                    model.traverse(function (child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            
                            // åº”ç”¨ç¯å¢ƒè´´å›¾
                            if (currentHDR) {
                                child.material.envMap = currentHDR;
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    scene.add(model);
                    
                    // å¤„ç†åŠ¨ç”»
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(model);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                        document.getElementById('toggle-animation').style.display = 'block';
                    } else {
                        document.getElementById('toggle-animation').style.display = 'none';
                    }
                    
                    // éšè—åŠ è½½ç•Œé¢
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                },
                function (xhr) {
                    // åŠ è½½è¿›åº¦æ›´æ–°
                    const percent = (xhr.loaded / xhr.total * 100);
                    progressBar.style.width = `${percent}%`;
                },
                function (error) {
                    console.error('æ¨¡å‹åŠ è½½å‡ºé”™:', error);
                    loadingOverlay.style.display = 'none';
                    
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    fileNameDisplay.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                    fileNameDisplay.style.color = '#ff6b6b';
                    
                    setTimeout(() => {
                        fileNameDisplay.textContent = '';
                        fileNameDisplay.style.color = '';
                    }, 3000);
                }
            );
        }
        
        // åŠ è½½HDRç¯å¢ƒè´´å›¾
        function loadHDREnvironment(file) {
            const reader = new FileReader();
            const fileNameDisplay = document.getElementById('hdr-file-name');
            const hdrPreview = document.getElementById('hdr-preview');
            
            fileNameDisplay.textContent = `å·²é€‰æ‹©: ${file.name}`;
            fileNameDisplay.style.color = '#4a9dfc';
            
            // æ˜¾ç¤ºä¸´æ—¶é¢„è§ˆ
            hdrPreview.innerHTML = `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#666;">
                HDRæ–‡ä»¶åŠ è½½ä¸­...
            </div>`;
            
            reader.onload = function(event) {
                const hdrData = event.target.result;
                
                // ä½¿ç”¨RGBELoaderè§£æHDR
                const loader = new THREE.RGBELoader();
                loader.load(hdrData, function(texture) {
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    
                    // æ›´æ–°ç¯å¢ƒè´´å›¾
                    if (currentHDR) {
                        scene.environment.dispose();
                    }
                    
                    scene.environment = texture;
                    currentHDR = texture;
                    
                    // æ›´æ–°æ¨¡å‹æè´¨çš„ç¯å¢ƒè´´å›¾
                    if (model) {
                        model.traverse(function(child) {
                            if (child.isMesh && child.material) {
                                child.material.envMap = texture;
                                child.material.needsUpdate = true;
                            }
                        });
                    }
                    
                    // åˆ›å»ºé¢„è§ˆå›¾åƒ
                    createHDRPreview(texture, hdrPreview);
                    
                    // æ›´æ–°ç¯å¢ƒä¿¡æ¯
                    document.getElementById('env-info').textContent = file.name;
                    document.getElementById('env-info').style.color = '#4a9dfc';
                    
                    // åº”ç”¨å½“å‰ç¯å¢ƒå…‰å¼ºåº¦
                    updateEnvIntensity();
                }, undefined, function(error) {
                    console.error('HDRåŠ è½½é”™è¯¯:', error);
                    fileNameDisplay.textContent = `HDRåŠ è½½å¤±è´¥: ${error.message}`;
                    fileNameDisplay.style.color = '#ff6b6b';
                    
                    hdrPreview.innerHTML = `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#ff6b6b;">
                        HDRåŠ è½½å¤±è´¥
                    </div>`;
                });
            };
            
            reader.readAsDataURL(file);
        }
        
        // åˆ›å»ºHDRé¢„è§ˆ
        function createHDRPreview(texture, container) {
            // åˆ›å»ºä¸´æ—¶canvasæ¸²æŸ“é¢„è§ˆ
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 200;
            
            // åˆ›å»ºä¸´æ—¶åœºæ™¯æ¸²æŸ“HDR
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
            camera.position.z = 1.5;
            
            const geometry = new THREE.SphereGeometry(1, 64, 32);
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.BackSide
            });
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            
            const renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                alpha: true,
                preserveDrawingBuffer: true
            });
            renderer.setSize(canvas.width, canvas.height);
            renderer.render(scene, camera);
            
            // åˆ›å»ºé¢„è§ˆå›¾åƒ
            const img = new Image();
            img.src = canvas.toDataURL();
            img.onload = function() {
                container.innerHTML = '';
                container.appendChild(img);
            };
        }
        
        // æ›´æ–°ç¯å¢ƒå…‰å¼ºåº¦
        function updateEnvIntensity() {
            const intensity = parseFloat(document.getElementById('env-intensity').value);
            document.getElementById('env-intensity-value').textContent = intensity.toFixed(1);
            
            if (scene.environment) {
                // è°ƒæ•´ç¯å¢ƒè´´å›¾å¼ºåº¦
                renderer.toneMappingExposure = intensity;
            }
            
            // è°ƒæ•´ç¯å¢ƒå…‰å¼ºåº¦
            envLight.intensity = intensity * 0.5;
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ—‹è½¬æ§åˆ¶
            document.getElementById('rotation-x').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('rotation-x-value').textContent = `${value}Â°`;
                if (model) model.rotation.x = THREE.MathUtils.degToRad(value);
            });
            
            document.getElementById('rotation-y').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('rotation-y-value').textContent = `${value}Â°`;
                if (model) model.rotation.y = THREE.MathUtils.degToRad(value);
            });
            
            // ç¼©æ”¾æ§åˆ¶
            document.getElementById('zoom').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('zoom-value').textContent = value;
                camera.position.z = 5 / value;
            });
            
            // ç¯å…‰æ§åˆ¶
            document.getElementById('light-intensity').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('light-intensity-value').textContent = value;
                directionalLight.intensity = value;
            });
            
            document.getElementById('light-color').addEventListener('input', function(e) {
                directionalLight.color = new THREE.Color(e.target.value);
            });
            
            // ç¯å¢ƒå…‰å¼ºåº¦æ§åˆ¶
            document.getElementById('env-intensity').addEventListener('input', updateEnvIntensity);
            
            // é˜´å½±åˆ‡æ¢
            document.getElementById('toggle-shadows').addEventListener('click', function() {
                renderer.shadowMap.enabled = !renderer.shadowMap.enabled;
                this.textContent = renderer.shadowMap.enabled ? 
                    'å…³é—­é˜´å½±' : 'å¼€å¯é˜´å½±';
            });
            
            // é‡ç½®æ¨¡å‹
            document.getElementById('reset-model').addEventListener('click', function() {
                if (model) {
                    model.rotation.set(0, 0, 0);
                    document.getElementById('rotation-x').value = 0;
                    document.getElementById('rotation-y').value = 0;
                    document.getElementById('rotation-x-value').textContent = '0Â°';
                    document.getElementById('rotation-y-value').textContent = '0Â°';
                    
                    document.getElementById('zoom').value = 1;
                    document.getElementById('zoom-value').textContent = '1';
                    camera.position.z = 5;
                }
            });
            
            // åˆ‡æ¢åŠ¨ç”»
            document.getElementById('toggle-animation').addEventListener('click', function() {
                if (mixer) {
                    if (mixer.timeScale === 0) {
                        mixer.timeScale = 1;
                        this.textContent = 'åœæ­¢åŠ¨ç”»';
                    } else {
                        mixer.timeScale = 0;
                        this.textContent = 'æ’­æ”¾åŠ¨ç”»';
                    }
                }
            });
            
            // æ›´æ¢é¢„ç½®æ¨¡å‹
            document.getElementById('change-model').addEventListener('click', function() {
                const modelKeys = Object.keys(models);
                const currentIndex = modelKeys.indexOf(currentModel);
                const nextIndex = (currentIndex + 1) % modelKeys.length;
                currentModel = modelKeys[nextIndex];
                loadModel(models[currentModel].path, models[currentModel].name, models[currentModel].size);
            });
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', function() {
                const canvasSection = document.querySelector('.canvas-section');
                const width = canvasSection.offsetWidth;
                const height = canvasSection.offsetHeight;
                
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });
            
            // æ¨¡å‹æ–‡ä»¶ä¸Šä¼ å¤„ç†
            document.getElementById('model-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
                if (!file.name.toLowerCase().endsWith('.glb')) {
                    alert('è¯·é€‰æ‹©GLBæ ¼å¼çš„æ–‡ä»¶ï¼');
                    return;
                }
                
                // æ˜¾ç¤ºæ–‡ä»¶å
                const fileNameDisplay = document.getElementById('upload-file-name');
                fileNameDisplay.textContent = `å·²é€‰æ‹©: ${file.name}`;
                fileNameDisplay.style.color = '#4a9dfc';
                
                // æ˜¾ç¤ºæ–‡ä»¶å¤§å°
                const fileSize = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                
                // åˆ›å»ºæ–‡ä»¶URL
                const url = URL.createObjectURL(file);
                
                // æ›´æ–°å½“å‰æ¨¡å‹åç§°
                currentModel = 'custom';
                
                // åŠ è½½æ¨¡å‹
                loadModel(url, file.name, fileSize);
                
                // æ¸…ç†URLå¯¹è±¡
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
            });
            
            // HDRæ–‡ä»¶ä¸Šä¼ å¤„ç†
            document.getElementById('hdr-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
                if (!file.name.toLowerCase().endsWith('.hdr')) {
                    alert('è¯·é€‰æ‹©HDRæ ¼å¼çš„æ–‡ä»¶ï¼');
                    return;
                }
                
                // åŠ è½½HDRç¯å¢ƒè´´å›¾
                loadHDREnvironment(file);
            });
            
            // åº”ç”¨HDRæŒ‰é’®
            document.getElementById('apply-hdr').addEventListener('click', function() {
                if (!currentHDR) {
                    alert('è¯·å…ˆä¸Šä¼ HDRæ–‡ä»¶ï¼');
                    return;
                }
                
                // ç¡®ä¿ç¯å¢ƒè´´å›¾å·²åº”ç”¨
                scene.environment = currentHDR;
                
                // æ›´æ–°æ¨¡å‹æè´¨çš„ç¯å¢ƒè´´å›¾
                if (model) {
                    model.traverse(function(child) {
                        if (child.isMesh && child.material) {
                            child.material.envMap = currentHDR;
                            child.material.needsUpdate = true;
                        }
                    });
                }
                
                updateEnvIntensity();
                alert('HDRç¯å¢ƒå…‰å·²åº”ç”¨ï¼');
            });
            
            // ç§»é™¤HDRæŒ‰é’®
            document.getElementById('remove-hdr').addEventListener('click', function() {
                if (scene.environment) {
                    scene.environment.dispose();
                    scene.environment = null;
                    currentHDR = null;
                    
                    // æ›´æ–°æ¨¡å‹æè´¨çš„ç¯å¢ƒè´´å›¾
                    if (model) {
                        model.traverse(function(child) {
                            if (child.isMesh && child.material) {
                                child.material.envMap = null;
                                child.material.needsUpdate = true;
                            }
                        });
                    }
                    
                    // é‡ç½®é¢„è§ˆ
                    document.getElementById('hdr-preview').innerHTML = 
                        `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#666;">
                            ä¸Šä¼ HDRåå°†æ˜¾ç¤ºé¢„è§ˆ
                        </div>`;
                    
                    document.getElementById('hdr-file-name').textContent = '';
                    document.getElementById('env-info').textContent = 'é»˜è®¤ç¯å¢ƒå…‰';
                    document.getElementById('env-info').style.color = '';
                    
                    alert('HDRç¯å¢ƒå…‰å·²ç§»é™¤ï¼');
                } else {
                    alert('å½“å‰æ²¡æœ‰åº”ç”¨HDRç¯å¢ƒå…‰ï¼');
                }
            });
            
            // æ·»åŠ é¼ æ ‡æ§åˆ¶
            let isDragging = false;
            let previousMousePosition = {
                x: 0,
                y: 0
            };
            
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
            renderer.domElement.addEventListener('mousedown', function(e) {
                isDragging = true;
                previousMousePosition = {
                    x: e.clientX,
                    y: e.clientY
                };
            });
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            renderer.domElement.addEventListener('mousemove', function(e) {
                if (!isDragging || !model) return;
                
                const deltaMove = {
                    x: e.clientX - previousMousePosition.x,
                    y: e.clientY - previousMousePosition.y
                };
                
                model.rotation.y += deltaMove.x * 0.01;
                model.rotation.x += deltaMove.y * 0.01;
                
                // æ›´æ–°æ»‘å—å€¼
                document.getElementById('rotation-x').value = THREE.MathUtils.radToDeg(model.rotation.x);
                document.getElementById('rotation-y').value = THREE.MathUtils.radToDeg(model.rotation.y);
                document.getElementById('rotation-x-value').textContent = 
                    `${Math.round(THREE.MathUtils.radToDeg(model.rotation.x))}Â°`;
                document.getElementById('rotation-y-value').textContent = 
                    `${Math.round(THREE.MathUtils.radToDeg(model.rotation.y))}Â°`;
                
                previousMousePosition = {
                    x: e.clientX,
                    y: e.clientY
                };
            });
            
            // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
            renderer.domElement.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            renderer.domElement.addEventListener('mouseleave', function() {
                isDragging = false;
            });
            
            // é¼ æ ‡æ»šè½®ç¼©æ”¾
            renderer.domElement.addEventListener('wheel', function(e) {
                if (!model) return;
                
                e.preventDefault();
                
                // è®¡ç®—æ–°çš„ç¼©æ”¾å€¼
                let zoomValue = parseFloat(document.getElementById('zoom').value);
                zoomValue += e.deltaY * -0.001;
                
                // é™åˆ¶ç¼©æ”¾èŒƒå›´
                zoomValue = Math.min(Math.max(zoomValue, 0.1), 2);
                
                // æ›´æ–°ç¼©æ”¾å€¼
                document.getElementById('zoom').value = zoomValue;
                document.getElementById('zoom-value').textContent = zoomValue.toFixed(2);
                camera.position.z = 5 / zoomValue;
            });
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            // æ›´æ–°æ§åˆ¶å™¨
            if (controls) controls.update();
            
            // æ›´æ–°åŠ¨ç”»æ··åˆå™¨
            if (mixer) {
                mixer.update(clock.getDelta());
            }
            
            // æ¸²æŸ“åœºæ™¯
            renderer.render(scene, camera);
        }
        
        // å¯åŠ¨åº”ç”¨
        window.onload = init;
    </script>
</body>
</html>
