<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 移动端视口优化 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, viewport-fit=cover">
    <!-- 内容安全策略 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline'; script-src 'self' https://cdn.jsdelivr.net https://thunkable.github.io 'unsafe-eval';">
    
    <!-- 样式重置 + 基础排版 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-normalize@2.0.0/modern-normalize.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --code-bg: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--primary-color);
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
        }

        /* Markdown渲染优化 */
        .markdown-container h1, .markdown-container h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }

        .markdown-container pre {
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .markdown-container code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            background: var(--code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        .markdown-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem auto;
        }

        /* 错误状态提示 */
        .error-message {
            color: #dc3545;
            padding: 1rem;
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 4px;
            background: #fff5f5;
        }

        /* 加载状态指示器 */
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #6c757d;
        }
    </style>
    
    <!-- 依赖库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>
<body>
    <!-- 状态容器 -->
    <div class="loading-indicator">内容加载中...</div>
    <div class="markdown-container"></div>
    <div class="error-message"></div>

    <script>
        (function() {
            'use strict';

            // 配置Marked解析器
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: true,  // 启用HTML过滤
                highlight: function(code) {
                    return code;  // 可集成highlight.js实现代码高亮
                }
            });

            // DOM元素引用
            const containers = {
                loading: document.querySelector('.loading-indicator'),
                content: document.querySelector('.markdown-container'),
                error: document.querySelector('.error-message')
            };

            // 消息处理函数
            function handleMessage(message) {
                try {
                    containers.loading.style.display = 'block';
                    containers.error.textContent = '';
                    
                    // 异步解析防止阻塞
                    setTimeout(() => {
                        const html = marked.parse(message.toString());
                        containers.content.innerHTML = html;
                        containers.loading.style.display = 'none';
                        
                        // 图片加载容错
                        Array.from(containers.content.querySelectorAll('img')).forEach(img => {
                            img.onerror = function() {
                                this.style.display = 'none';
                            };
                        });
                    }, 50);
                } catch (error) {
                    containers.loading.style.display = 'none';
                    containers.error.textContent = `内容解析错误: ${error.message}`;
                    console.error('Markdown解析错误:', error);
                }
            }

            // 初始化消息监听
            document.addEventListener('DOMContentLoaded', () => {
                ThunkableWebviewerExtension.receiveMessage(handleMessage);
                
                // 超时检测
                setTimeout(() => {
                    if (!containers.content.innerHTML && !containers.error.textContent) {
                        containers.error.textContent = '内容加载超时，请检查网络连接';
                    }
                }, 10000);
            });

            // 视口变化监听
            window.addEventListener('resize', () => {
                containers.content.style.fontSize = 
                    window.innerWidth < 480 ? '16px' : '18px';
            });
        })();
    </script>
</body>
</html>
